[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
chown=root:root

[supervisord]
; run in foreground so container logs show supervisor output
nodaemon=true
logfile=/workspace/logs/supervisord.log
pidfile=/var/run/supervisord.pid
; suppress “running as root” warning explicitly
user=root

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; ---------- Programs ----------
; Lower priority numbers start first

[program:qdrant-init]
priority=110
command=/bin/bash -lc "/workspace/bin/qdrant_init.sh"
autorestart=false
startretries=0
stdout_logfile=/workspace/logs/qdrant-init.out
stderr_logfile=/workspace/logs/qdrant-init.err
stopsignal=INT
stopwaitsecs=5

[program:ollama]
priority=120
directory=/workspace
command=/usr/local/bin/ollama serve
autostart=true
autorestart=true
startsecs=4
stdout_logfile=/workspace/logs/ollama.out
stderr_logfile=/workspace/logs/ollama.err
environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",OLLAMA_MODELS="/workspace/ollama"

[program:ollama-pull]
priority=130
command=/bin/bash -lc "/workspace/bin/ollama_pull.sh"
autostart=true
autorestart=false
startretries=1
stdout_logfile=/workspace/logs/ollama-pull.out
stderr_logfile=/workspace/logs/ollama-pull.err
environment=OLLAMA_URL="http://127.0.0.1:11434",MODEL_LIST_FILE="/workspace/dantive-regbot/ops/model-list.txt"

[program:api]
priority=200
directory=/workspace/dantive-regbot/apps/api
command=/bin/bash -lc 'exec /workspace/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000'
autostart=true
autorestart=true
startsecs=4
stdout_logfile=/workspace/logs/api.out
stderr_logfile=/workspace/logs/api.err
environment=DATABASE_URL="postgresql://rag:ragpwd@127.0.0.1:5432/ragdb",QDRANT_URL="http://127.0.0.1:6333",OLLAMA_URL="http://127.0.0.1:11434",QDRANT_COLLECTION="regdocs_v1",OLLAMA_DEFAULT_MODEL="mistral:7b-instruct",OLLAMA_CONNECT_TIMEOUT="10",OLLAMA_READ_TIMEOUT="600",PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

[program:ui]
priority=300
directory=/workspace/dantive-regbot/apps/ui
command=/bin/bash -lc 'exec /workspace/venv/bin/streamlit run /workspace/dantive-regbot/apps/ui/streamlit_app.py --server.port 8501 --server.address 0.0.0.0'
autostart=true
autorestart=true
startsecs=4
stdout_logfile=/workspace/logs/ui.out
stderr_logfile=/workspace/logs/ui.err
environment=API_URL="http://127.0.0.1:8000",PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
