[unix_http_server]
file=/workspace/supervisor.sock
chmod=0700

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
chown=root:root

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; Lower priority numbers start first
[program:postgres]
priority=50
command=/usr/lib/postgresql/14/bin/postgres -D /workspace/postgres
# user=postgres
autorestart=true
stdout_logfile=/var/log/supervisor/postgres.out
stderr_logfile=/var/log/supervisor/postgres.err

[program:qdrant]
priority=100
command=/bin/bash -lc "QDRANT__STORAGE__STORAGE_PATH=/workspace/qdrant QDRANT__SERVICE__HTTP_PORT=6333 qdrant"
autorestart=true
stdout_logfile=/var/log/supervisor/qdrant.out
stderr_logfile=/var/log/supervisor/qdrant.err

[program:qdrant-init]
priority=110
command=/bin/bash -lc "/workspace/bin/qdrant_init.sh"
autorestart=false
startretries=0
stdout_logfile=/var/log/supervisor/qdrant-init.out
stderr_logfile=/var/log/supervisor/qdrant-init.err

[program:ollama]
priority=120
command=/bin/bash -lc "OLLAMA_NUM_PARALLEL=1 OLLAMA_KEEP_ALIVE=30m OLLAMA_HOST=0.0.0.0:11434 ollama serve"
autorestart=true
stdout_logfile=/var/log/supervisor/ollama.out
stderr_logfile=/var/log/supervisor/ollama.err
environment=NVIDIA_VISIBLE_DEVICES="all",NVIDIA_DRIVER_CAPABILITIES="compute,utility"

[program:ollama-pull]
priority=130
command=/bin/bash -lc "/workspace/bin/ollama_pull.sh"
autorestart=false
startretries=0
stdout_logfile=/var/log/supervisor/ollama-pull.out
stderr_logfile=/var/log/supervisor/ollama-pull.err
environment=OLLAMA_MODELS="mistral:7b-instruct,nomic-embed-text"


[program:api]
directory=/workspace/dantive-regbot/apps/api
command=/bin/bash -lc 'cd /workspace/dantive-regbot/apps/api && /workspace/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000'
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/api.out
stderr_logfile=/workspace/logs/api.err
startsecs=4
priority=200
environment=DATABASE_URL="postgresql://rag:ragpwd@127.0.0.1:5432/ragdb",QDRANT_URL="http://127.0.0.1:6333",OLLAMA_URL="http://127.0.0.1:11434",QDRANT_COLLECTION="regdocs_v1",OLLAMA_DEFAULT_MODEL="mistral:7b-instruct",OLLAMA_CONNECT_TIMEOUT="10",OLLAMA_READ_TIMEOUT="600"

[program:ui]
directory=/workspace/dantive-regbot/apps/ui
command=/bin/bash -lc '/workspace/venv/bin/streamlit run /workspace/dantive-regbot/apps/ui/streamlit_app.py --server.port 8501 --server.address 0.0.0.0'
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/ui.out
stderr_logfile=/workspace/logs/ui.err
startsecs=4
priority=300
environment=API_URL="http://127.0.0.1:8000"
