[unix_http_server]
file=/workspace/supervisor.sock
chmod=0700

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
chown=root:root

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; Lower priority numbers start first
[program:qdrant-init]
priority=110
command=/bin/bash -lc "/workspace/bin/qdrant_init.sh"
autorestart=false
startretries=0
stdout_logfile=/var/log/supervisor/qdrant-init.out
stderr_logfile=/var/log/supervisor/qdrant-init.err

[program:ollama-pull]
priority=130
command=/bin/bash -lc "/workspace/bin/ollama_pull.sh"
autorestart=false
startretries=0
stdout_logfile=/var/log/supervisor/ollama-pull.out
stderr_logfile=/var/log/supervisor/ollama-pull.err
environment=OLLAMA_MODELS="mistral:7b-instruct,nomic-embed-text"

#[program:postgres]
#priority=100
#directory=/workspace/postgres
#command=/bin/bash -lc 'exec "$(command -v postgres)" -D /workspace/postgres'
#autostart=true
#autorestart=true
#stdout_logfile=/workspace/logs/postgres.out
#stderr_logfile=/workspace/logs/postgres.err
#startsecs=4
#environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

#[program:qdrant]
#priority=110
#directory=/workspace/qdrant
#command=/bin/bash -lc 'exec qdrant --config-path /workspace/qdrant/config.yaml'
#autostart=true
#autorestart=true
#stdout_logfile=/workspace/logs/qdrant.out
#stderr_logfile=/workspace/logs/qdrant.err
#startsecs=4
#environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

[program:ollama]
priority=120
directory=/workspace
command=/bin/bash -lc 'export OLLAMA_MODELS=/workspace/ollama; exec /usr/local/bin/ollama serve'
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/ollama.out
stderr_logfile=/workspace/logs/ollama.err
startsecs=4
environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",OLLAMA_MODELS="/workspace/ollama"

[program:api]
priority=200
directory=/workspace/dantive-regbot/apps/api
command=/bin/bash -lc 'cd /workspace/dantive-regbot/apps/api && exec /workspace/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000'
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/api.out
stderr_logfile=/workspace/logs/api.err
startsecs=4
environment=DATABASE_URL="postgresql://rag:ragpwd@127.0.0.1:5432/ragdb",QDRANT_URL="http://127.0.0.1:6333",OLLAMA_URL="http://127.0.0.1:11434",QDRANT_COLLECTION="regdocs_v1",OLLAMA_DEFAULT_MODEL="mistral:7b-instruct",OLLAMA_CONNECT_TIMEOUT="10",OLLAMA_READ_TIMEOUT="600",PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

[program:ui]
priority=300
directory=/workspace/dantive-regbot/apps/ui
command=/bin/bash -lc 'exec /workspace/venv/bin/streamlit run /workspace/dantive-regbot/apps/ui/streamlit_app.py --server.port 8501 --server.address 0.0.0.0'
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/ui.out
stderr_logfile=/workspace/logs/ui.err
startsecs=4
environment=API_URL="http://127.0.0.1:8000",PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
